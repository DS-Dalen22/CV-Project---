# Дублирование кода из обоих ноутбуков Google Collab

import zipfile
import os
from google.colab import files
from google.colab import drive
drive.mount('/content/drive')

!cp /content/drive/MyDrive/Citypersons.v9i.yolov8.zip .
!unzip Citypersons.v9i.yolov8.zip


zip_file = "/content/Citypersons.v9i.yolov8.zip"
zip_path = "/content/Citypersons.v9i.yolov8"

#Распаковка
with zipfile.ZipFile(zip_file, 'r') as zip_ref:
    zip_ref.extractall(zip_path)

print(f"Zip file '{zip_file}' has been extracted to '{zip_path}'")

#Вывод датасета по файлам и количества содержимых в нем изображений
for root, dirs, files in os.walk(zip_path):
  print(f"Папка: {root}, Файлов: {len(files)}")

#Создание переменных для файлов с изображениями и разметками уже разделенных на три выборки
train_image_folder = '/content/Citypersons.v9i.yolov8/train/images/'
train_label_folder = '/content/Citypersons.v9i.yolov8/train/labels/'

val_image_folder = '/content/Citypersons.v9i.yolov8/valid/images/'
val_label_folder = '/content/Citypersons.v9i.yolov8/valid/labels/'

test_image_folder = '/content/Citypersons.v9i.yolov8/test/images/'
test_label_folder = '/content/Citypersons.v9i.yolov8/test/labels/'


#Пример вывода изображения и его метки
train_images = os.listdir(train_image_folder)
train_labels = os.listdir(train_label_folder)

image_name = train_images[0]
label_name = image_name.replace('.jpg', '.txt')

print(f"Изображение: {image_name}")
print(f"Аннотация: {label_name}")

with open(os.path.join(train_label_folder, label_name), 'r') as label_file:
    annotations = label_file.readlines()
    for annotation in annotations:
        print(annotation.strip())


!pip install albumentations
import os
import cv2
import numpy as np
import random
from shutil import copyfile
from PIL import Image
from albumentations import (
    Compose, OneOf, HorizontalFlip, VerticalFlip, Rotate, RandomBrightnessContrast, CLAHE, HueSaturationValue, RandomCrop, BboxParams
)

from albumentations import Compose
import json



# Подготовительный этап, агументация данных библиотекой albumentations

aug = Compose([
    HorizontalFlip(p=0.5),
    RandomBrightnessContrast(p=0.3),
    HueSaturationValue(hue_shift_limit=20, sat_shift_limit=30, val_shift_limit=20, p=0.5)
], bbox_params=BboxParams(format='yolo', min_visibility=0.1))


def augment_single_image(img_path, label_path, output_img_dir, output_label_dir):
    """
    Функция для аугментации одного изображения и соответствующих ему разметок (боксов).
    - img_path: путь к исходному изображению
    - label_path: путь к файлу с разметкой (YOLO формат)
    - output_img_dir: куда сохранить аугментированное изображение
    - output_label_dir: куда сохранить обновлённую разметку
    """

    img = cv2.imread(img_path)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)

    with open(label_path, 'r') as f:
        lines = f.readlines()

    bboxes = []
    for line in lines:
        class_id, x_center, y_center, width, height = map(float, line.split())
        bboxes.append([x_center, y_center, width, height])

    if bboxes:
        augmented = aug(image=img, bboxes=bboxes)
        aug_img = augmented['image']
        aug_bboxes = augmented['bboxes']
    else:
        aug_img = img
        aug_bboxes = []

    os.makedirs(output_img_dir, exist_ok=True)
    os.makedirs(output_label_dir, exist_ok=True)

    output_img_path = os.path.join(output_img_dir, os.path.basename(img_path))
    cv2.imwrite(output_img_path, cv2.cvtColor(aug_img, cv2.COLOR_RGB2BGR))

    output_label_path = os.path.join(output_label_dir, os.path.basename(label_path))
    with open(output_label_path, 'w') as f:
        for bbox in aug_bboxes:
            f.write(f"0 {bbox[0]} {bbox[1]} {bbox[2]} {bbox[3]}\n")  # class_id=0 (person)


input_image_dir = "/content/Citypersons.v9i.yolov8/train/images/"
input_label_dir = "/content/Citypersons.v9i.yolov8/train/labels/"
output_image_dir = "/content/train/augmented/images"
output_label_dir = "/content/train/augmented/labels"

for img_name in os.listdir(input_image_dir):
    if img_name.endswith('.jpg'):
        img_path = os.path.join(input_image_dir, img_name)
        label_path = os.path.join(input_label_dir, img_name.replace('.jpg', '.txt'))

        if os.path.exists(label_path):
            augment_single_image(img_path, label_path, output_image_dir, output_label_dir)

print("Аугментация завершена")
